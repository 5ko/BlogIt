jQuery.noConflict(),jQuery(document).ready(function(t){BlogIt.fn.showMsg({msg:t(BlogIt.pm["skin-classes"]["blog-form"]+" .wikimessage").html(),result:"error"}),BlogIt.fn.showMsg({msg:t(BlogIt.pm["skin-classes"]["comment-form"]+" .wikimessage").html(),result:"success"}),BlogIt.fn.addValidation(),BlogIt.fn.addAutocomplete(),window.location.href.match(/action=bi_admin/)&&(BlogIt.pm["skin-classes"]["comment-tag"]="li"),t(document).on("click",'.bi-link-comment-unapproved[href*="bi_mode=ajax"],.bi-Comment-Approve',function(t){BlogIt.fn.adminAction(t,"approve")}),t(document).on("click",'.bi-link-comment-approved[href*="bi_mode=ajax"],.bi-Comment-Unapprove',function(t){BlogIt.fn.adminAction(t,"unapprove")}),t(document).on("click",'.bi-link-blog-new[href*="bi_mode=ajax"],.bi-link-blog-edit[href*="bi_mode=ajax"],.bi-link-comment-edit[href*="bi_mode=ajax"],.bi-link-comment-reply',function(t){BlogIt.fn.showEdit(t)}),t(document).on("click",'.bi-link-comment-delete[href*="bi_mode=ajax"],.bi-link-blog-delete[href*="bi_mode=ajax"],.bi-Comment-Delete',function(t){BlogIt.fn.adminAction(t,"delete")}),t(document).on("click",".bi-link-comment-block,.bi-Comment-Block",function(t){BlogIt.fn.adminAction(t,"block")}),t(document).on("click",".bi-Comment-AllNone",function(t){BlogIt.fn.toggleCheckboxes(t)}),t(document).on("click",BlogIt.pm["skin-classes"].comment+".blogit-admin",function(e){t(e.target).is("a,input")||BlogIt.fn.commentAdminCheckbox(this,"flip")}),t(document).on({mouseenter:function(){BlogIt.fn.commentAdminCheckbox(this,"show",!1)},mouseleave:function(){BlogIt.fn.commentAdminCheckbox(this,"hide",!0)}},BlogIt.pm["skin-classes"].comment+".blogit-admin"),t(BlogIt.pm["skin-classes"]["comment-summary-title"]+","+BlogIt.pm["skin-classes"]["comment-block-title"]+".blogit-admin").append(t('<span class="blogit-cam-marker" />').html("&#9660")).jBox("Tooltip",{trigger:"mouseenter",content:'<ul class="blogit-comment-admin-menu"><li class="bi-Comment-AllNone">All</li><li class="bi-Comment-Approve">Approve</li><li class="bi-Comment-Unapprove">Unapprove</li><li class="bi-Comment-Block">Block</li><li class="bi-Comment-Delete">Delete</li>',pointer:"left",position:{x:"left",y:"bottom"},offset:{x:50,y:-5},closeOnMouseleave:!0,onOpen:function(){this.source.addClass("bi-menu-hover")},onClose:function(){this.source.removeClass("bi-menu-hover")}}),t(BlogIt.pm["skin-classes"]["blog-form"]+" form :input:not(:submit)").on("change",function(){t(window).on("beforeunload",function(){return BlogIt.fn.xl("You have unsaved changes.")})})});var BlogIt={fmt:{},xl:{},fn:{},pm:{}};BlogIt.fn=function($){function updateCommentCount(t,e){function o(t,e){var o=t.text().replace(/\n/g,""),n=o.match(/\d+/).join("");t.text(o.replace(n,parseInt(n)+e))}$(BlogIt.pm["skin-classes"]["approved-comment-count"]).each(function(e,n){o($(n),t)}),$(BlogIt.pm["skin-classes"]["unapproved-comment-count"]).each(function(t,n){o($(n),e)})}function getIDWrapper(t){var e=$(t).closest('[id^="bi_ID"]');return e.length?e:null}function getCommentBlock(){var t=$(".bi-menu-hover").next("ol.blogit-comment-admin-list");return t.length>0?t:$(BlogIt.pm["skin-classes"]["comment-list-block"])}function closestTemplateObject(t){var e=[BlogIt.pm["skin-classes"]["blog-entry"],BlogIt.pm["skin-classes"]["comment-admin-list"],BlogIt.pm["skin-classes"]["blog-entry-summary"],BlogIt.pm["skin-classes"]["blog-list-row"],BlogIt.pm["skin-classes"]["comment-list"]],o=t.closest(e.join(","));return o.length?o:null}function objectRemove(t,e){$(t).each(function(){var t=getIDWrapper(this);t.hasClass(BlogIt.pm["skin-classes"].comment.replace(/^\./,""))&&($("a",t).hasClass("blogit-comment-approved")?updateCommentCount(-1,0):updateCommentCount(0,-1)),t.fadeOut(500,function(){$(this).remove()})}),BlogIt.fn.showMsg(e)}function flipCommentStatus(t,e){e=e||"flip",$(t).each(function(){var t=getIDWrapper(this);flash(t);var o=$(this).hasClass("bi-link-comment-approved");("flip"==e||"unapprove"==e&&o||"approve"==e&&!o)&&(this.href=o?this.href.replace("action=bi_cua","action=bi_ca"):this.href.replace("action=bi_ca","action=bi_cua"),$(this).html(BlogIt.fn.xl(o?"approve":"unapprove")),t.removeClass("blogit-comment-"+(o?"":"un")+"approved").addClass("blogit-comment-"+(o?"un":"")+"approved"),$(this).removeClass("bi-link-comment-"+(o?"":"un")+"approved").addClass("bi-link-comment-"+(o?"un":"")+"approved"),o?updateCommentCount(-1,1):updateCommentCount(1,-1))})}function dialogWait(t){$(".jBox-title div:not(.jBox-closeButton)").css(t?{background:""}:{background:"url( "+BlogIt.pm.pubdirurl+"/wait.gif) no-repeat left center",width:"18px",height:"18px"})}function dialogShow(txt,yes,no,w,ajax){var prompt=new jBox("Confirm",{content:txt,_onOpen:function(){this.submitButton.off("click.jBox-Confirm"+this.id).on("click.jBox-Confirm"+this.id,function(){this.options.confirm?this.options.confirm():eval(this.source.data("jBox-Confirm-submit"))}.bind(this))},confirmButton:BlogIt.fn.xl(yes),cancelButton:BlogIt.fn.xl(no),confirm:function(){BlogIt.fn.ajax(ajax),prompt.close()},onCloseComplete:function(){this.destroy()},width:w,minWidth:w,maxWidth:w}).open()}function flash(t){t.delay(100).css("-webkit-transition","all 0.7s ease").css("backgroundColor","white").css("-moz-transition","all 0.7s ease").css("-o-transition","all 0.7s ease").css("-ms-transition","all 0.7s ease").css("backgroundColor","#ACACAC").delay(300).queue(function(){$(this).css("backgroundColor","white"),$(this).dequeue()})}function ajaxSubmit(t,e,o){var n,i,l;if(dialogWait(),$('[name="bi_mode"]',t).length||t.prepend('<input type="hidden" name="bi_mode" value="ajax">'),o&&(l=$(o.target).is("img")?o.currentTarget:o.target),"pmform"!=$('[name="action"]',t).val()||o&&!l.href.match(/action=bi_(cr|ce|be|ne)/)||$('[name="bi_frm_action"]',t).length||t.prepend('<input type="hidden" name="bi_frm_action" value="'+(o?l.href.match(/action=bi_(cr|ce|be|ne)/)[1]:"ca")+'">'),o){var a=closestTemplateObject($(l));i=a?"."+a.attr("class").split(" ")[0]:"",$('[name="bi_context"]',t).length||t.prepend('<input type="hidden" name="bi_context" value="'+i+'">'),n=$(getIDWrapper(l)||a)}BlogIt.fn.ajax({method:"POST",url:t.attr("action"),data:t.serialize(),success:function(t){(!t||t&&"error"!=t.result)&&dialog&&dialog.close(),t.out?e(t,l,n,i):BlogIt.fn.showMsg({msg:t.msg||BlogIt.fn.xl("No data returned."),result:t.result||"error"})}})}function updateBlog(t,e,o,n){var i=$(t.out).bi_seek(n);o.replaceWith(i),flash(i),BlogIt.fn.showMsg(t)}function updateComment(t,e,o,n){if("error"!=t.result){var i=0==$(BlogIt.pm["skin-classes"]["comment-list"]).length,l=i?$(t.out):$(t.out).bi_seek('[id^="bi_ID"]'),a=l.hasClass("blogit-comment-approved");!e||$(e).is(".bi-link-comment-reply")?(e||($(BlogIt.pm["skin-classes"]["comment-list-wrapper"]+"+form")[0].reset(),$(BlogIt.pm["skin-classes"]["comment-submit"]+' img[src*="action=captchaimage"]').replaceWith($('img[src*="action=captchaimage"]',t.dom)),$(BlogIt.pm["skin-classes"]["comment-submit"]+' input[name="captchakey"]').replaceWith($('input[name="captchakey"]',t.dom)),a?updateCommentCount(1,0):updateCommentCount(0,1)),$(e?closestTemplateObject(o):BlogIt.pm["skin-classes"][i?"comment-list-wrapper":"comment-list"]).append(l)):$(e).is(".bi-link-comment-edit")&&(o.replaceWith(l),a!=o.hasClass("blogit-comment-approved")&&(a?updateCommentCount(1,-1):updateCommentCount(-1,1)))}flash(l),BlogIt.fn.showMsg(t)}$.ajaxSetup({timeout:15e3,dataType:"json",contentType:"application/x-www-form-urlencoded",error:function(t,e){BlogIt.fn.showMsg({result:"error",msg:"parsererror"==e?"Parsing JSON request failed.":"timeout"==e?"Request timeout.":"Error: "+e+"\n"+t.readyState+"\nresponseText: "+t.responseText})}});var dialog;return $.fn.bi_seek=function(t){var e;return this.each(function(){var o=jQuery(this);return e=o.find(t),e.length<1&&(e=o.filter(t)),1==e.length?!1:void 0}),e},$.validator.addMethod("datetime",function(t,e){return this.optional(e)||RegExp(BlogIt.fmt["entry-date"]).test(t)},BlogIt.xl["Must be a datetime."]),$.validator.addMethod("require_from_group",function(t,e,o){var n=$(o[1],e.form),i=n.eq(0),l=i.data("valid_req_grp")?i.data("valid_req_grp"):$.extend({},this),a=n.filter(function(){return l.elementValue(this)}).length>=o[0];return i.data("valid_req_grp",l),$(e).data("being_validated")||(n.data("being_validated",!0),n.each(function(){l.element(this)}),n.data("being_validated",!1)),a},$.validator.format("Please fill at least {0} of these fields.")),{toggleCheckboxes:function(t){var e=$(t.target),o=getCommentBlock();o.children(BlogIt.pm["skin-classes"]["comment-tag"]).each(function(){e.html()==BlogIt.fn.xl("All")?BlogIt.fn.commentAdminCheckbox(this,"show",!0):BlogIt.fn.commentAdminCheckbox(this,"hide",!1)}),e.html(e.html()==BlogIt.fn.xl("All")?BlogIt.fn.xl("None"):BlogIt.fn.xl("All"))},commentAdminCheckbox:function(t,e,o){"flip"==e?$('input[name="bi_CommentID[]"]',t).prop("checked",function(){return!$(this).prop("checked")}):"show"==e?($('input[name="bi_CommentID[]"]',t).length||$(".blogit-admin-links .blogit-admin-link:last",t).after('<input type="checkbox" name="bi_CommentID[]" value="'+$(t).attr("id")+'">'),o&&$('input[name="bi_CommentID[]"]',t).prop("checked",!0)):$('input[name="bi_CommentID[]"]'+(o?":not(:checked)":""),t).remove()},createURL:function(t,e){if(t.target.href){t.preventDefault();var o=1,n=t.target.href;t=$(t.target)}else{var i=getCommentBlock(),o=$('input[name="bi_CommentID[]"]',i).length;if(o>0){var l=".bi-link-comment-"+e+("approve"==e||"unapprove"==e?"d":"")+":first";("approve"==e||"unapprove"==e)&&(l+=",.bi-link-comment-"+("approve"==e?"unapproved":"approved")+":first");var n=$(l,i).slice(0,1).attr("href")+"&"+$('[name="bi_CommentID[]"]:checked',i).serialize();("approve"==e||"unapprove"==e)&&(n=n.replace(/action=bi_c(a|ua)/,"approve"==e?"action=bi_ca":"action=bi_cua")),t=$('[name="bi_CommentID[]"]:checked',i).closest(BlogIt.pm["skin-classes"]["comment-tag"]+BlogIt.pm["skin-classes"].comment).find(l)}}return{rc:o,url:n,e:t}},adminAction:function(t,e){url=BlogIt.fn.createURL(t,e),url.rc>0&&("delete"==e?dialogShow(BlogIt.fn.xl("Are you sure you want to delete ")+url.rc+BlogIt.fn.xl(" row"+(url.rc>1?"s":"")+"?"),"Yes","No",300,{url:url.url,success:function(t){objectRemove(url.e,t)}}):"block"==e?BlogIt.fn.ajax({url:url.url,success:function(t){t.ip&&dialogShow(BlogIt.fn.xl("Enter the IP to block:")+'<textarea id="blogit_ip" type="text">'+t.ip+"</textarea>","Submit","Cancel",200,{url:function(){return url.url+encodeURI("&bi_ip="+$("#blogit_ip").val().replace(/\n/g,","))},success:function(t){BlogIt.fn.showMsg(t)}})}}):BlogIt.fn.ajax({url:url.url,success:function(t){"error"==t.result&&BlogIt.fn.showMsg(t),flipCommentStatus(url.e,e)}}))},showEdit:function(e){e.preventDefault(),BlogIt.fn.ajax({url:e.currentTarget.href,success:function(data){if("success"==data.result){var blog=$(e.currentTarget).is(".bi-link-blog-edit,.bi-link-blog-new");dialog=new jBox("Confirm",{title:"&nbsp",content:blog?$(data.out).filter("#wikiedit"):$(data.out),_onOpen:function(){this.submitButton.off("click.jBox-Confirm"+this.id).on("click.jBox-Confirm"+this.id,function(){this.options.confirm?this.options.confirm():eval(this.source.data("jBox-Confirm-submit"))}.bind(this))},closeButton:"title",confirm:function(){$(".jBox-content form").submit()},confirmButton:BlogIt.fn.xl("Submit"),cancelButton:BlogIt.fn.xl("Cancel"),onCloseComplete:function(){this.destroy()},width:blog?750:430,minWidth:blog?750:430,maxWidth:1e4}).open(),BlogIt.fn.addAutocomplete(),BlogIt.fn.addValidation(e)}else BlogIt.fn.showMsg(data||{msg:"Error on edit return.",result:"error"})}})},addValidation:function(t){$(BlogIt.pm["skin-classes"]["blog-form"]+" form").each(function(){$(this).validate({submitHandler:function(e){$(e).parents(".jBox-content").length?ajaxSubmit($(e),updateBlog,t):($(window).off("beforeunload"),e.submit())},rules:{ptv_entrydate:{datetime:!0},ptv_entryurl:{require_from_group:[1,'input[name="ptv_entrytitle"],input[name="ptv_entryurl"]']},ptv_entrytitle:{require_from_group:[1,'input[name="ptv_entrytitle"],input[name="ptv_entryurl"]']}}})}),$(".jBox-content form,"+BlogIt.pm["skin-classes"]["comment-list-wrapper"]+"+form").each(function(){$(this).validate({submitHandler:function(e){/action=bi_ce/.test(t.target.href)&&($m=t.target.href.match(/bi_base=(.*\..*)&/),$m&&$('[name="ptv_blogit_basepage"][value=""]',e).val($m[1])),ajaxSubmit($(e),updateComment,t)},rules:{ptv_commentauthor:{required:!0},ptv_email:{required:!0,email:!0},ptv_website:{url:!0}}})})},addAutocomplete:function(){$('input[name="ptv_entrytags"]').each(function(){new Awesomplete(this,{list:BlogIt.pm.categories.split(","),autoFirst:!0,filter:function(t,e){return Awesomplete.FILTER_CONTAINS(t,e.match(/[^,]*$/)[0])},replace:function(t){var e=this.input.value.match(/^.+,\s*|/)[0];this.input.value=e+t+", "}})}),$(document).on("blur","#entrytags",function(){$this=$(this),$this.val($this.val().replace(/[,|\s]+$/,""))})},showMsg:function(t){t.msg&&new jBox("Notice",{content:BlogIt.fn.xl(t.msg),addClass:"error"==t.result?"error":"success",closeButton:"error"==t.result?!0:!1,closeOnClick:"error"==t.result?"box":null,closeOnEsc:"error"==t.result?!0:!1,autoClose:"error"==t.result?!1:BlogIt.pm["ajax-message-timer"],position:{x:"left",y:"top"}})},xl:function(t){return BlogIt.xl[t]?$("<div>"+BlogIt.xl[t]+"</div>").html():t},ajax:function(t){t.url="function"==typeof t.url?t.url():t.url,$.ajax(t)}}}(jQuery);